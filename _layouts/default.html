<!DOCTYPE html>
<html lang="ko">
  {%- include head.html -%}
  <body>

    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KCBVCCTX" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <div class="gtranslate_wrapper"></div>

    {{ content }}

    <button id="floating-demo-btn" class="floating-demo-btn">Contexton</button>
    <div id="mobile-ui-container" class="mobile-ui-container">
      <p>사용자 인터페이스 영역</p>
      <p>(클라이언트 연결 작업 중)</p> <!--mobile-ui-container에 연결-->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const contentArea = document.getElementById('content-area');
        // [수정됨] 감지 범위를 전체 nav(.unified-nav)로 확장
        const unifiedNav = document.querySelector('.unified-nav');
        // [수정됨] 활성 메뉴를 토글할 링크 범위를 전체 nav의 링크로 확장
        const navLinks = unifiedNav ? unifiedNav.querySelectorAll('a[data-mdfile]') : [];
        
        const siteBaseUrl = '{{ site.baseurl }}';

        //==================================================
        //  [추가] 데모용 UI 요소 참조
        //==================================================
        const floatingBtn = document.getElementById('floating-demo-btn');
        const mobileUiContainer = document.getElementById('mobile-ui-container');
        //==================================================

        const walkTokens = (token) => {
          if (token.type === 'image' && !token.href.startsWith('http')) {
            if (token.href.startsWith('/')) {
              token.href = siteBaseUrl + token.href;
            }
          }
        };
        marked.use({ walkTokens });

        // Giscus 스크립트를 동적으로 로드하는 함수
        function loadGiscus() {
          const giscusContainer = document.getElementById('giscus-container');
          if (!giscusContainer) return;

          const existingScript = document.getElementById('giscus-script');
          if (existingScript) {
            existingScript.remove();
          }
          
          const script = document.createElement('script');
          script.id = 'giscus-script';
          script.src = "https://giscus.app/client.js";
          
          /* 관리자 Giscus 정보 업데이트 */
          script.setAttribute('data-repo', "hamnYK/WorfBS");
          script.setAttribute('data-repo-id', "R_kgDOP1voKQ");
          script.setAttribute('data-category', "Announcements");
          script.setAttribute('data-category-id', "DIC_kwDOP1voKc4Cv0rD");

          script.setAttribute('data-mapping', "pathname");
          script.setAttribute('data-strict', "0");
          script.setAttribute('data-reactions-enabled', "1");
          script.setAttribute('data-emit-metadata', "0");
          script.setAttribute('data-input-position', "bottom");
          script.setAttribute('data-theme', "light");
          script.setAttribute('data-lang', "ko");
          script.setAttribute('crossorigin', "anonymous");
          script.async = true;
          
          giscusContainer.appendChild(script);
        }

        function updateActiveMenu(activeId) {
          // [수정됨] navLinks 변수를 사용
          navLinks.forEach(link => {
            link.classList.toggle('active-menu', link.id === activeId);
          });
        }

        function loadContent(mdFile) {
          const menuId = 'menu-' + mdFile.replace('.md', '');
          fetch(siteBaseUrl + "/" + mdFile)
            .then(response => {
              if (!response.ok) {
                throw new Error('파일 로딩 실패: ' + response.statusText);
              }
              return response.text();
            })
            .then(markdownText => {
              if (contentArea) {
                const contentOnly = markdownText.replace(/^---[\s\S]*?---\s*/, '').trim();
                contentArea.innerHTML = marked.parse(contentOnly);
                updateActiveMenu(menuId);
                loadGiscus(); 
              }
            })
            .catch(error => {
              console.error('콘텐츠 로딩 오류:', error);
              if(contentArea) contentArea.innerHTML = "<p>콘텐츠를 불러오는 데 실패했습니다. 파일 경로를 확인해주세요.</p>";
            });
        }
        
        //==================================================
        //  [수정] 이벤트 리스너 통합 관리
        //==================================================
        document.body.addEventListener('click', function(e) {
            const targetLink = e.target.closest('a');

            // 1. MD파일 로드 로직 (기존 기능)
            if (targetLink && targetLink.dataset.mdfile && !targetLink.classList.contains('active-menu')) {
                e.preventDefault();
                const mdFile = targetLink.dataset.mdfile;
                loadContent(mdFile);
            }

            // 2. 'Demo Link' 클릭 처리 로직 (요청 기능)
            if (targetLink && targetLink.id === 'start-demo-link') {
                e.preventDefault();
                if (floatingBtn) {
                  floatingBtn.style.display = 'block';
                }
            }

            // 3. 플로팅 버튼 클릭 처리 로직 (요청 기능)
            if (e.target.id === 'floating-demo-btn') {
                if (mobileUiContainer) {
                    const isDisplayed = mobileUiContainer.style.display === 'flex';
                    mobileUiContainer.style.display = isDisplayed ? 'none' : 'flex';
                }
            }
        });
        //==================================================
        
        if (contentArea) {
            loadContent('servicesolution.md');
        }
      });
    </script>
  </body>
</html>