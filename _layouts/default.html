<!DOCTYPE html>
<html lang="ko">
  {%- include head.html -%}
  <body>

    <!-- Google Tag Manager (noscript) -->
      <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KCBVCCTX" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <div class="gtranslate_wrapper"></div>

    {{ content }}

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const contentArea = document.getElementById('content-area');
        // [수정됨] 감지 범위를 전체 nav(.unified-nav)로 확장
        const unifiedNav = document.querySelector('.unified-nav');
        // [수정됨] 활성 메뉴를 토글할 링크 범위를 전체 nav의 링크로 확장
        const navLinks = unifiedNav ? unifiedNav.querySelectorAll('a[data-mdfile]') : [];
        
        const siteBaseUrl = '{{ site.baseurl }}';

        const walkTokens = (token) => {
          if (token.type === 'image' && !token.href.startsWith('http')) {
            if (token.href.startsWith('/')) {
              token.href = siteBaseUrl + token.href;
            }
          }
        };
        marked.use({ walkTokens });

        // Giscus 스크립트를 동적으로 로드하는 함수
        function loadGiscus() {
          const giscusContainer = document.getElementById('giscus-container');
          if (!giscusContainer) return;

          const existingScript = document.getElementById('giscus-script');
          if (existingScript) {
            existingScript.remove();
          }
          
          const script = document.createElement('script');
          script.id = 'giscus-script';
          script.src = "https://giscus.app/client.js";
          
          /* 관리자 Giscus 정보 업데이트 */
          script.setAttribute('data-repo', "hamnYK/WorfBS");
          script.setAttribute('data-repo-id', "R_kgDOP1voKQ");
          script.setAttribute('data-category', "Announcements");
          script.setAttribute('data-category-id', "DIC_kwDOP1voKc4Cv0rD");

          script.setAttribute('data-mapping', "pathname");
          script.setAttribute('data-strict', "0");
          script.setAttribute('data-reactions-enabled', "1");
          script.setAttribute('data-emit-metadata', "0");
          script.setAttribute('data-input-position', "bottom");
          script.setAttribute('data-theme', "light");
          script.setAttribute('data-lang', "ko");
          script.setAttribute('crossorigin', "anonymous");
          script.async = true;
          
          giscusContainer.appendChild(script);
        }

        function updateActiveMenu(activeId) {
          // [수정됨] navLinks 변수를 사용
          navLinks.forEach(link => {
            link.classList.toggle('active-menu', link.id === activeId);
          });
        }

        function loadContent(mdFile) {
          const menuId = 'menu-' + mdFile.replace('.md', '');
          fetch(siteBaseUrl + "/" + mdFile)
            .then(response => {
              if (!response.ok) {
                throw new Error('파일 로딩 실패: ' + response.statusText);
              }
              return response.text();
            })
            .then(markdownText => {
              if (contentArea) {
                const contentOnly = markdownText.replace(/^---[\s\S]*?---\s*/, '').trim();
                contentArea.innerHTML = marked.parse(contentOnly);
                updateActiveMenu(menuId);
                loadGiscus(); 
              }
            })
            .catch(error => {
              console.error('콘텐츠 로딩 오류:', error);
              if(contentArea) contentArea.innerHTML = "<p>콘텐츠를 불러오는 데 실패했습니다. 파일 경로를 확인해주세요.</p>";
            });
        }

        // [수정됨] 이벤트 리스너를 unifiedNav에 연결
        if (unifiedNav) {
            unifiedNav.addEventListener('click', function(e) {
              const targetLink = e.target.closest('a');
              // data-mdfile 속성이 있는 링크만 내부 로딩 처리
              if (targetLink && targetLink.dataset.mdfile && !targetLink.classList.contains('active-menu')) {
                e.preventDefault();
                const mdFile = targetLink.dataset.mdfile;
                loadContent(mdFile);
              }
            });
        }
        
        if (contentArea) {
            loadContent('servicesolution.md');
        }
      });
    </script>
  </body>
</html>